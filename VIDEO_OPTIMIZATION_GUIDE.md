# 视频处理内存优化指南

## 问题描述

Qwen2.5-VL 模型在处理视频时可能出现 GPU 内存不足 (OOM) 错误，而 Qwen3-VL 模型通常可以正常工作。这是因为两个模型在处理视频时的内存使用模式不同。

## 解决方案

### 1. 调整像素参数

**最重要的优化参数：**

- **max_pixels**: 建议设置为 `640 * 28 * 28` 或更小
- **min_pixels**: 建议设置为 `256 * 28 * 28` 或更小

**计算示例：**
- 640 * 28 * 28 = 501,760 像素
- 256 * 28 * 28 = 200,704 像素

### 2. 使用量化模型

在模型加载器中选择量化选项：
- **INT4**: 最大内存节省，但可能影响质量
- **INT8**: 平衡内存使用和质量
- **FP8**: 如果支持，提供良好的内存/质量平衡

### 3. 调整生成参数

- **max_new_tokens**: 视频处理时建议限制在 1024 以内
- **temperature**: 保持默认值 0.7

### 4. 系统优化

- 关闭其他占用 GPU 内存的程序
- 确保有足够的 VRAM（建议 8GB+）
- 使用较新的 GPU 驱动

## 推荐配置

### 低内存配置 (4-6GB VRAM)
```
max_pixels: 256 * 28 * 28
min_pixels: 64 * 28 * 28
precision: INT4
max_new_tokens: 512
```

### 中等内存配置 (6-8GB VRAM)
```
max_pixels: 640 * 28 * 28
min_pixels: 256 * 28 * 28
precision: INT8
max_new_tokens: 1024
```

### 高内存配置 (8GB+ VRAM)
```
max_pixels: 1280 * 28 * 28
min_pixels: 256 * 28 * 28
precision: FP16
max_new_tokens: 2048
```

## 故障排除

### 如果仍然出现 OOM 错误：

1. **进一步降低像素参数**
   - 尝试 max_pixels: 320 * 28 * 28
   - 尝试 min_pixels: 128 * 28 * 28

2. **使用更小的模型**
   - Qwen2.5-VL-3B-Instruct 而不是 7B
   - 或者使用 Qwen3-VL-2B-Instruct

3. **检查视频文件**
   - 确保视频文件不是损坏的
   - 尝试使用较短的视频片段
   - 降低视频分辨率

4. **系统检查**
   - 运行 `nvidia-smi` 检查 GPU 内存使用
   - 确保没有其他程序占用大量 GPU 内存

## 技术说明

像素参数控制模型处理的视觉令牌数量：
- 更多像素 = 更高质量但更多内存
- 更少像素 = 更少内存但可能影响质量

视频处理比图像处理需要更多内存，因为：
- 视频包含多个帧
- 需要处理时间序列信息
- 模型需要维护视频的上下文

## 更新日志

- v1.4.0: 添加了像素控制参数和内存优化功能
- 改进了错误处理和用户提示
- 添加了视频处理专用优化
